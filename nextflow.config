/*
 * ======================================================
 *  eukaryotic-genome-assembly default configuration file
 * ======================================================
 */

summary {
  name = 'eukaryotic-genome-assembly'
  author = 'Thilo Schulze'
  website = 'https://github.com/ThiloSchulze/eukaryotic-genome-assembly'
  description = 'A pipeline for eukaryotic genome assembly'
  mainScript = 'main.nf'
  nextflowVersion = '!>=20.04.1'
  version = '1.1'
}

params {
  // Mandatory option
  reads = null

  // Miscellaneous
  help = false
  version = false

  // Input/output options
  single_end = false
  output = "assembly_out"

  // Resource allocation
  max_retries = 1
  max_cpus = Runtime.getRuntime().availableProcessors() // # of threads
  // Memory allocation guide:
  //   B = bytes, KB = kilobytes, MB = megabytes, GB = gigabytes, and
  //   TB = terabytes
  //   Example: '256 GB'
  max_memory = Runtime.getRuntime().maxMemory() // memory on machine
  // Time allocation guide:
  //   d = days, h = hours, m = minutes, s = seconds
  //   Example: '3d'
  max_time = '3d'

  // Quality control (FastQC)
  qc_adapters = null

  // Trimming (Trim Galore!)
  trim_min_length = 55
  trim_quality = 20
  trim_adapter = null
  trim_phred64 = null
  trim_forward_leading = null
  trim_forward_trailing = null
  trim_reverse_leading = null
  trim_reverse_trailing = null
  trim_leading_cutoff = null
  trim_trailing_cutoff = null

  // Assembly (SPAdes)
  kmers = [77]
}

profiles {
  standard {
    process {
      withLabel:big_mem {
        time = { params.max_time * task.attempt }
        cpus = { params.max_cpus * task.attempt }
        memory = { params.max_memory * task.attempt }
      }
      withName:qualityControl {
        cpus = { params.max_cpus * task.attempt }
        time = { 6.h * task.attempt }
      }
      withName:trimming {
        cpus = { params.max_cpus * task.attempt }
        time = { 6.h * task.attempt }
      }
      withName:assemblyQualityAssessment {
        cpus = { params.max_cpus * task.attempt }
        time = { 6.h * task.attempt }
      }
    }
  }
  cluster {
    process.scratch        = true
    scratch                = "/scratch2/$USER"
    singularity.enabled    = true
    singularity.autoMounts = true

    process {
      withLabel:big_mem {
        time               = { params.max_time * task.attempt }
        cpus               = { params.max_cpus * task.attempt }
        memory             = params.max_memory
        clusterOptions     = { '--qos=long' }
        queue              = 'fat+'
        errorStrategy      = 'retry'
        maxRetries         = params.max_retries
      }
    }

    executor {
      name                 = 'slurm'
      queueSize            = 50
      submitRateLimit      = '10 sec'
    }
  }
  conda {
    process.conda          = "$baseDir/environment.yml"
    params.enable_conda    = true
  }
  docker {
    docker.enabled         = true
    docker.userEmulation   = true

    process {
      withName:qualityControl {
        container = 'quay.io/biocontainers/fastqc:0.11.9--hdfd78af_1'
      }
      withName:trimming {
        container = 'quay.io/biocontainers/trim-galore:0.6.7--hdfd78af_0'
      }
      withName:assembly {
        container = 'quay.io/biocontainers/spades:3.15.3--h95f258a_0'
      }
      withName:assemblyQualityAssessment {
        container = 'quay.io/biocontainers/quast:5.0.2--py36pl5262h30a8e3e_4'
      }
      withName:rawReadsStats {
        container = 'quay.io/biocontainers/seqkit:2.0.0--h9ee0642_0'
      }
      withName:coverageEstimation {
        container = 'quay.io/biocontainers/genomescope2:2.0--py39r40hdfd78af_4'
      }
    }
  }
  singularity {
    singularity.enabled    = true
    singularity.autoMounts = true

    process {
      withName:qualityControl {
        container = 'docker://quay.io/biocontainers/fastqc:0.11.9--hdfd78af_1'
      }
      withName:trimming {
        container = 'docker://quay.io/biocontainers/trim-galore:0.6.7--hdfd78af_0'
      }
      withName:assembly {
        container = 'docker://quay.io/biocontainers/spades:3.15.3--h95f258a_0'
      }
      withName:assemblyQualityAssessment {
        container = 'docker://quay.io/biocontainers/quast:5.0.2--py36pl5262h30a8e3e_4'
      }
      withName:rawReadsStats {
        container = 'docker://quay.io/biocontainers/seqkit:2.0.0--h9ee0642_0'
      }
      withName:trimmedReadsStats {
        container = 'docker://quay.io/biocontainers/seqkit:2.0.0--h9ee0642_0'
      }
      withName:coverageEstimation {
        container = 'docker://quay.io/biocontainers/genomescope2:2.0--py39r40hdfd78af_4'
      }
    }
  }
}

// Write tracing and visualisation files
def trace_timestamp = new java.util.Date().format( 'yyyy-MM-dd_HH-mm-ss')

timeline {
  enabled = true
  file = "${params.output}/trace/timeline_${trace_timestamp}.html"
}
report {
  enabled = true
  file = "${params.output}/trace/report_${trace_timestamp}.html"
}
trace {
  enabled = true
  file = "${params.output}/trace/trace_${trace_timestamp}.txt"
}
dag {
  enabled = true
  file = "${params.output}/trace/dag_${trace_timestamp}.svg"
}

// Capture exit codes from upstream processes when piping
process.shell = ['/bin/bash', '-euo', 'pipefail']

// Prevents local Python/R libraries from conflicting with those in the
// container
env {
    PYTHONNOUSERSITE = 1
    R_PROFILE_USER   = "/.Rprofile"
    R_ENVIRON_USER   = "/.Renviron"
}
